#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–±–∏–π—Å—Ç–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É
kill_port() {
    lsof -ti:$1 | xargs kill -9 2>/dev/null
}

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

# –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üî™ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 8080 –∏ 8081..."
kill_port 8080
kill_port 8081

# –ó–∞–ø—É—Å–∫–∞–µ–º Frontend
echo "üé® –ó–∞–ø—É—Å–∫ Frontend (http://localhost:8080)..."
cd docs
# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏—Ö–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –ª–æ–≥–∏
python3 -m http.server 8080 > /dev/null 2>&1 &
FRONTEND_PID=$!
cd ..

# –ó–∞–ø—É—Å–∫–∞–µ–º Backend
echo "‚öôÔ∏è –ó–∞–ø—É—Å–∫ Backend (http://localhost:8081)..."
echo "üìù –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤"
echo "----------------------------------------"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–∫–µ—Ä
if [ -f .env ]; then
    export $(cat .env | xargs)
fi

python3 local_worker.py &
BACKEND_PID=$!

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞ (Ctrl+C)
cleanup() {
    echo ""
    echo "üëã –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    kill $FRONTEND_PID 2>/dev/null
    kill $BACKEND_PID 2>/dev/null
    exit
}

trap cleanup SIGINT

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
wait
